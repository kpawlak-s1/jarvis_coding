{
  "attributes": {
    "dataSource.vendor": "Akamai",
    "dataSource.name": "Akamai CDN",
    "dataSource.category": "network",
    "dataSource.technology": "content_delivery_network",
    "source": "akamai_cdn"
  },
  
  "patterns": {
    "timestamp": "\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z",
    "ip_address": "\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}",
    "status_code": "\\d{3}",
    "cache_status": "(HIT|MISS|PASS)",
    "http_method": "(GET|POST|PUT|DELETE|HEAD|OPTIONS|PATCH)",
    "quoted_string": "\"[^\"]*\"",
    "field_value": "[^\\s]+"
  },
  
  "formats": [
    {
      "id": "akamai_cdn_access_log",
      "format": "$timestamp$ AkamaiCDN streamId=$quoted_string{name=stream_id}$ cp=$quoted_string{name=config_id}$ reqId=$quoted_string{name=request_id}$ statusCode=$status_code{name=status_code}$ cliIP=$quoted_string{name=client_ip}$ reqHost=$quoted_string{name=host}$ reqMethod=$quoted_string{name=method}$ reqPath=$quoted_string{name=path}$ bytes=$field_value{name=bytes}$ cacheStatus=$quoted_string{name=cache_status}$ turnAroundTimeMSec=$field_value{name=response_time_ms}$ edgeIP=$quoted_string{name=edge_ip}$ country=$quoted_string{name=country}$ city=$quoted_string{name=city}$",
      "attributes": {
        "dataSource.app": "Akamai CDN Access Logs",
        "class_uid": 4002,
        "class_name": "HTTP Activity", 
        "category_uid": 4,
        "category_name": "Network Activity",
        "type_uid": 400201,
        "activity_id": 1,
        "activity_name": "HTTP Request",
        "severity_id": 1
      },
      "rewrites": [
        {
          "input": "timestamp",
          "output": "time",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "client_ip", 
          "output": "src_endpoint.ip",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "edge_ip",
          "output": "dst_endpoint.ip", 
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "host",
          "output": "http_request.hostname",
          "match": ".*", 
          "replace": "$0"
        },
        {
          "input": "method",
          "output": "http_request.http_method",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "path",
          "output": "http_request.url.path",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "status_code",
          "output": "http_response.code",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "bytes",
          "output": "http_response.length",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "response_time_ms",
          "output": "response_time",
          "match": ".*", 
          "replace": "$0"
        },
        {
          "input": "cache_status",
          "output": "enrichments.cache_status",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "country",
          "output": "src_endpoint.location.country",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "city", 
          "output": "src_endpoint.location.city",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "request_id",
          "output": "metadata.correlation_uid",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "stream_id",
          "output": "metadata.log_name",
          "match": ".*",
          "replace": "$0"
        },
        {
          "input": "status_code",
          "output": "status_id",
          "match": "^2\\d{2}$",
          "replace": "1"
        },
        {
          "input": "status_code", 
          "output": "status_id",
          "match": "^[45]\\d{2}$",
          "replace": "2"
        },
        {
          "input": "client_ip",
          "output": "observables",
          "match": ".*",
          "replace": "[{\"name\":\"src_ip\",\"type\":\"IP Address\",\"value\":\"$0\"},{\"name\":\"hostname\",\"type\":\"Hostname\",\"value\":\"${host}\"}]"
        }
      ],
      "halt": true
    }
  ]
}